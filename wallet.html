<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wallet â€“ Freelance Hub</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <a href="landing.html" class="brand">Freelance Hub</a>
        <nav>
            <a href="home.html">Jobs</a>
            <a href="postjob.html">Post Job</a>
            <a href="messages.html">Messages</a>
            <a href="notifications.html">Notifications</a>
            <a href="profile.html">Profile</a>
        </nav>
    </header>

    <main class="container">
        <h2>ðŸ’° Wallet</h2>

        <div class="wallet-overview">
            <div class="wallet-card">
                <h3>Current Balance</h3>
                <p id="walletBalance" class="big-amount">â‚¹0.00</p>
                <div class="wallet-actions">
                    <button class="btn btn-primary" onclick="openTopUpModal()">Add Funds</button>
                    <button class="btn btn-secondary" onclick="openWithdrawModal()">Withdraw</button>
                    <button class="btn" onclick="viewTransactions()">View Transactions</button>
                </div>
            </div>

            <div class="wallet-info">
                <div class="wallet-section">
                    <h4>Quick Send</h4>
                    <p>Send money to a freelancer's wallet instantly.</p>
                    <label>Recipient User ID</label>
                    <input id="sendRecipient" type="number" placeholder="e.g. 102" />
                    <label>Amount (â‚¹)</label>
                    <input id="sendAmount" type="number" step="0.01" placeholder="1000" />
                    <button class="btn btn-primary" onclick="sendToUser()">Send</button>
                </div>

                <div class="wallet-section">
                    <h4>Withdraw Methods</h4>
                    <p>Withdraw to UPI or bank (manual processing).</p>
                    <label>Withdrawal Method</label>
                    <select id="withdrawMethod">
                        <option value="upi">UPI</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                    <label>UPI ID / Bank Details</label>
                    <input id="withdrawDetails" type="text" placeholder="your-upi@bank or A/C details" />
                </div>
            </div>
        </div>

        <section id="transactionsSection" style="display:none; margin-top:24px;">
            <h3>Recent Transactions</h3>
            <table class="table" id="transactionsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- rows added dynamically -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- Top Up Modal -->
    <div id="topUpModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeTopUpModal()">&times;</span>
            <h3>Add Funds</h3>
            <label>Amount (â‚¹)</label>
            <input id="topUpAmount" type="number" step="0.01" placeholder="500.00" />

            <label>Payment Method</label>
            <select id="topUpMethod">
                <option value="card">Card</option>
                <option value="upi">UPI</option>
                <option value="wallet">External Wallet</option>
            </select>

            <button class="btn btn-primary" onclick="topUp()">Proceed</button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeWithdrawModal()">&times;</span>
            <h3>Request Withdrawal</h3>
            <label>Amount (â‚¹)</label>
            <input id="withdrawAmount" type="number" step="0.01" placeholder="1000.00" />
            <label>Method</label>
            <select id="withdrawMethodModal">
                <option value="upi">UPI</option>
                <option value="bank">Bank Transfer</option>
            </select>
            <label>UPI ID / Bank Details</label>
            <input id="withdrawDetailsModal" type="text" placeholder="your-upi@bank or A/C details" />
            <button class="btn btn-primary" onclick="requestWithdraw()">Request Withdrawal</button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p class="footer-text">Â© 2024 Freelance Hub.</p>
            <a href="https://shubhamsharmaa05.github.io/Being.pandit/being.pandit.html" target="_blank" class="creator-link">Created by <span class="highlight">Being.Pandit</span></a>
        </div>
    </footer>

    <script>
        // Assumes API_URL and getCurrentUser() are defined in script.js included globally in the project
        const API = (typeof API_URL !== 'undefined') ? API_URL : 'http://localhost:5500';

        function openTopUpModal(){ document.getElementById('topUpModal').style.display='block'; }
        function closeTopUpModal(){ document.getElementById('topUpModal').style.display='none'; }
        function openWithdrawModal(){ document.getElementById('withdrawModal').style.display='block'; }
        function closeWithdrawModal(){ document.getElementById('withdrawModal').style.display='none'; }

        async function loadWallet(){
            const user = getCurrentUser();
            if(!user){ window.location.href='login.html'; return; }

            try{
                const res = await fetch(`${API}/wallets/${user.user_id}`);
                const data = await res.json();
                if(data.status === 'success'){
                    document.getElementById('walletBalance').innerText = formatCurrency(data.wallet.balance);
                }
            }catch(err){ console.error('Wallet load error', err); }
        }

        async function viewTransactions(){
            const user = getCurrentUser();
            if(!user) return;
            document.getElementById('transactionsSection').style.display='block';

            try{
                const res = await fetch(`${API}/wallets/${user.user_id}/transactions`);
                const data = await res.json();
                if(data.status === 'success'){
                    const tbody = document.querySelector('#transactionsTable tbody');
                    tbody.innerHTML='';
                    data.transactions.forEach(tx => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${tx.transaction_id}</td>
                            <td>${tx.type}</td>
                            <td>â‚¹${parseFloat(tx.amount).toFixed(2)}</td>
                            <td>${tx.description || ''}</td>
                            <td>${new Date(tx.created_at).toLocaleString()}</td>
                            <td>${tx.status || 'completed'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }catch(err){ console.error('Transactions load error', err); }
        }

        async function topUp(){
            const user = getCurrentUser(); if(!user) return;
            const amount = parseFloat(document.getElementById('topUpAmount').value);
            const method = document.getElementById('topUpMethod').value;
            if(!amount || amount <= 0){ alert('Enter valid amount'); return; }

            // Placeholder: call backend to create a payment & update wallet on success
            try{
                const res = await fetch(`${API}/wallets/topup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.user_id, amount, method })
                });
                const data = await res.json();
                if(data.status === 'success'){
                    alert('Top up successful');
                    closeTopUpModal();
                    loadWallet();
                } else alert(data.message || 'Top up failed');
            }catch(err){ console.error('TopUp error', err); alert('Server error'); }
        }

        async function requestWithdraw(){
            const user = getCurrentUser(); if(!user) return;
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.getElementById('withdrawMethodModal').value;
            const details = document.getElementById('withdrawDetailsModal').value;
            if(!amount || amount <= 0 || !details){ alert('Enter amount and details'); return; }

            try{
                const res = await fetch(`${API}/wallets/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.user_id, amount, method, details })
                });
                const data = await res.json();
                if(data.status === 'success'){
                    alert('Withdrawal requested');
                    closeWithdrawModal();
                    loadWallet();
                } else alert(data.message || 'Withdraw failed');
            }catch(err){ console.error('Withdraw error', err); alert('Server error'); }
        }

        async function sendToUser(){
            const user = getCurrentUser(); if(!user) return;
            const recipient = parseInt(document.getElementById('sendRecipient').value);
            const amount = parseFloat(document.getElementById('sendAmount').value);
            if(!recipient || !amount || amount <= 0){ alert('Enter recipient and valid amount'); return; }

            try{
                const res = await fetch(`${API}/wallets/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from_user_id: user.user_id, to_user_id: recipient, amount })
                });
                const data = await res.json();
                if(data.status === 'success'){
                    alert('Transfer successful');
                    loadWallet();
                } else alert(data.message || 'Transfer failed');
            }catch(err){ console.error('Transfer error', err); alert('Server error'); }
        }

        // Utils
        function formatCurrency(n){ return 'â‚¹' + parseFloat(n || 0).toFixed(2); }

        // Load on start
        document.addEventListener('DOMContentLoaded', loadWallet);
    </script>

    <style>
        .wallet-overview{ display:flex; gap:20px; margin-top:20px; align-items:flex-start; }
        .wallet-card{ background:#0a0a0a; border:2px solid #1a1a1a; padding:20px; border-radius:8px; width:320px; }
        .big-amount{ font-size:32px; color:#FF6B6B; margin:8px 0 16px; }
        .wallet-actions{ display:flex; gap:10px; flex-wrap:wrap; }
        .wallet-info{ flex:1; display:flex; gap:20px; flex-direction:column; }
        .wallet-section{ background:#0a0a0a; border:2px solid #1a1a1a; padding:16px; border-radius:8px; }
        .table{ width:100%; border-collapse:collapse; }
        .table th, .table td{ padding:10px; border-bottom:1px solid #1a1a1a; text-align:left; }
        .modal{ position:fixed; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
        .modal-content{ background:#0a0a0a; border:2px solid #1a1a1a; padding:20px; border-radius:8px; width:90%; max-width:480px; }
        .modal .close{ float:right; cursor:pointer; font-size:22px; }
        input, select{ width:100%; padding:10px; margin:8px 0 12px; background:#000; border:1px solid #222; color:#fff; border-radius:6px; }
        .btn{ padding:10px 18px; border-radius:6px; background:transparent; border:1px solid #FF6B6B; color:#FF6B6B; cursor:pointer; }
        .btn-primary{ background:#FF6B6B; color:#000; border-color:#FF6B6B; }
        .btn-secondary{ background:transparent; color:#fff; border-color:#1a1a1a; }
    </style>
</body>
</html>